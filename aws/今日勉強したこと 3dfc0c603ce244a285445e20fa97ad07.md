# 今日勉強したこと

学習したことを具体的に: AWSのEC2について
学習したもの: AWS
学習方法: その他オンライン動画
日付: 2022年7月8日

# Amazonコンピューティング

## EC2(Elastic Compute Cloud)

AmazonEC2は、規模の変更が可能なコンピューティング性能をクラウド内で安全に利用できるウェブサービス。

EC2インスタンスと呼ばれる仮想サーバーをプロビジョニングできる。

AWS従量課金モデルのためアプリケーションの需要にインフラストラクチャの容量を合わせることができる

EC2インスタンスはAWSマネジメントコンソール、AWS CLI、AWS SDK、自動化ツール、インフラストラクチャオーケストレーションサービスを使用して、作成かつ管理する。

EC2インスタンスを作成するには以下を定義する必要がある。

- CPU、メモリ、ネットワーク、ストレージなどのハードウェア仕様
- ネットワークの場所、ファイアウォールのルール、認証などの論理構成や、選択したOS

EC2インスタンスを起動するときに、最初に設定するのはAmazonマシンイメージ（AMI）を選択して使用するOS。

### AMI

Amazonマシンイメージ（AMI）はインスタンスの起動に必要な情報を提供する。

インスタンスを起動するときはAMIを指定する必要がある。

AWSクラウドではAMIにOSが組み込まれている。

ストレージマッピング、アーキテクチャの種類、インストールされている追加のソフトウェアを選択できる。

AMIに以下が含まれている。

- 1つまたは複数のAmazon Elastic Block Store（Amazon EBS）スナップショット、またはinstance-store-backed AMI、インスタンスのルートボリュームのテンプレート（OS、アプリケーションサーバー、アプリケーションなど）
- AWSアカウントがAMIを使用してインスタンスを起動可能にするための起動許可
- インスタンスの起動時にインスタンスにアタッチするボリュームを指定するブロックデバイスマッピング

- AMIとEC2インスタンスの関係
    
    EC2インスタンスはAMIで定義されているライブインスタンス化のことであり、レシピからケーキを作ったようなもの。
    
    新しいインスタンスを起動するとAWSはハイパーバイザーで実行する仮想マシンを割り当てる。次にAMIがルートデバイスボリュームにコピーされる。ルートデバイスボリュームには、ボリュームの起動に使用されるイメージが含まれる。
    
    最終的にパッケージと追加のソフトウェアに接続してインストールできるサーバーが得られる。
    
    AMIを使用することの利点は再利用可能であるということ。同じAMIを使用すると同じ設定のインスタンスが得られる。
    

- AMIを探す
    
    AMIは次のカテゴリから選択できる
    
    - 迅速に開始できるようAWSにより作成されているクイックスタートAMI
    - サードパーティから人気のあるオープンソースと商用ソフトウェアを提供するAWS Marketplace AMI
    - EC2インスタンスから作成されたMy AMI
    - AWSユーザーコミュニティにより提供されたコミュニティAMI
    - EC2 Image Builderを使用して独自のカスタムイメージを構築する
    
    AWSマネジメントコンソールの各AMIにはAMI IDがあり、先頭に`ami-`が付き、その後に文字のランダムなハッシュ値が続く。IDは各リージョンに固有。
    

### EC2インスタンスタイプ

EC2インスタンスは仮想プロセッサ（vCPU)、メモリ、ネットワーク、場合によってはインスタンスストレージとGPUの組み合わせ。EC2インスタンスを作成するときは各コンポーネントに必要な容量を選択する必要がある。

インスタンスの容量の詳細を確認するにはインスタンスタイプを調べる必要がある。

インスタンスタイプは最適化対象のワークロードのタイプを識別するプレフィックスとサイズがある。例えば、インスタンスタイプ**`c5.large`**は次のように分類できる

- **c5**はインスタンスファミリーと世代番号を決定する。ここではインスタンスは汎用計算用に最適化されたインスタンスファミリーの５番目の世代のインスタンスにい属する
- **large**はインスタンスの容量を決定する

- インスタンスファミリー
    
    各インスタンスファミリーはさまざまなユースケースにい合わせて最適化されている。
    
    | インスタンスファミリー | 説明 | ユースケース |
    | --- | --- | --- |
    | 汎用 | バランスの取れたコンピューティング、メモリ、ネットワークのリソースを提供 | ウェブサーバー、キャッシュサーバー、分散データストアなど |
    | コンピューティング最適化 | 高パフォーマンスプロセッサの恩恵を受けるコンピューティング関連アプリに最適 | ハイパフォーマンスのウェブサーバー、科学的モデリング、バッチ処理、高性能コンピューティング、機械学習、広告サービスなど |
    | メモリ最適化 | メモリ内の大きいデータセットを処理するワークロードに対して高速なパフォーマンスを実現 | 高パフォーマンスデータベース、分散型ウェブスケールインメモリキャッシュ、リアルタイムのビックデータ分析など |
    | 高速コンピューティング | ハードウェアアクセラレーターを使い、CPUで実行するソフトウェアよりも効率的に実行する | 3Dビジュアライゼーション、3Dレンダリング、アプリケーションストリーミング、動画エンコーディングなど |
    | ストレージ最適化 | ローカルストレージの大規模データセットに対して高速の読み取りと書き込みを必要とするワークロード向け | NoSQLデータベースでトランザクションデータベース、Elasticsearchなどをスケールアウト |

- EC2インスタンスの場所
    
    デフォルトではEC2インスタンスはデフォルトのAmazon Viertual Private Cloud（Amazon VPC）と呼ばれるネットワークに配置される。
    
    デフォルトVPC内に配置したリソースはインターネットで公開され、アクセス可能になるため顧客データや個人情報を保管しないこと。
    
    独自のカスタムVPCを選択し、追加のルーティングと接続メカニズムを使用してアクセスを制限する必要がある。
    

- 高可用性を実現する
    
    インスタンスは選択したアベイラビリティーゾーンに存在する。
    
    アベイラビリティーゾーンレベルで提供範囲が設定されているAWSサービスは高可用性を考慮する必要がある
    
    2つが1つよりも優れ、3つが2つよりも優れている。
    
    フロントエンドにインスタンスが1つしかなく、インスタンスに障害が発生するとアプリケーションは停止する。ワークロードが10インスタンスにい分散され、1つのインスタンスに障害が発生しても10%だけのためアプリケーションにほとんど影響がない。
    
    高可用性を実現するアプリケーションを設計する場合は、2つの異なるアベイラビリティーゾーンで少なくとも2つのEC2インスタンスを使用することを検討する。
    

- インスタンスのライフサイクル
    
    ![https://i.gyazo.com/2496cf1fd62e0bec2cfb7d43703d0e18.png](https://i.gyazo.com/2496cf1fd62e0bec2cfb7d43703d0e18.png)
    
    1. インスタンスを起動すると、インスタンスは**保留**状態に移行します。インスタンスが保留中の場合、請求は開始されていません。この段階で、インスタンスは起動状態に入る準備をしています。保留中は、AMI コンテンツをルートデバイスにコピーし、必要なネットワークコンポーネントの割り当てなど、インスタンスのセットアップに必要なすべてのアクションを AWS が実行している状態です。
    2. インスタンスが**実行されると**使用できる状態になります。これは課金が始まる段階でもあります。インスタンスが実行されるとすぐに、インスタンスに対して再起動、終了、停止、停止休止などの他のアクションを実行できます。
    3. インスタンスを再起動すると、停止アクションを実行してから開始アクションを実行することとは異なります。**インスタンスの再起動**はオペレーティングシステムの再起動と同等です。インスタンスは同じホストコンピュータに残り、そのパブリックとプライベート IP アドレス、およびその他のデータをインスタンスストアに維持します。
    4. 再起動が終了するまで通常数分かかります。インスタンスを停止して起動すると、インスタンスが新しい基盤となる物理サーバーに配置されることがあります。そのため、前のホストコンピュータにあったインスタンスストア上のデータは失われます。インスタンスを停止すると、インスタンスは新しいパブリック IP アドレスを取得しますが、同じプライベート IP アドレスを保持します。
    5. **インスタンスを終了すると**、インスタンスストアは消去され、マシンのパブリック IP アドレスとプライベート IP アドレスの両方が失われます。インスタンスの終了はマシンにアクセスできなくなったことを意味します。
    

- 停止と停止-休止の違い
    
    インスタンスを停止すると、停止状態になるまで停止状態になる。
    
    インスタンスを停止した後はインスタンスの使用量やデータ転送料金は課金されることはないがAmazon EBSボリュームのストレージは引き続き課金される。
    
    停止状態にある間、インスタンスタイプなどの一部の属性を変更できる。
    
    インスタンスを停止すると、メモリに保管されているデータは失われる。
    
    インスタンスを停止-休止状態にするとAWSはオペレーティングシステムに休止状態を実行するように通知する。これによりインスタンスメモリからAmazon EBSルートボリュームにコンテンツが保存される。
    

- 料金
    
    EC2でコストを削減する方法の一つはアプリケーションの実行方法に適した価格オプションを選択すること
    
    - オンデマンド・・・使った分だけ
    - リザーブド・・・割引。期間を決める
    - スポット・・・高い割引。支払う金額を制限できる

# Rails